name: Build MIPS64 Big-Endian gdbserver

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential crossbuild-essential-mips64 wget libgmp-dev libmpfr-dev libmpc-dev

    - name: Download GDB source
      run: |
        wget http://ftp.gnu.org/gnu/gdb/gdb-14.1.tar.xz
        tar xf gdb-14.1.tar.xz

    - name: Configure and build for MIPS64 big-endian
      run: |
        cd gdb-14.1/gdb/gdbserver
        ../../../configure --target=mips64-linux-gnu --host=mips64-linux-gnu --disable-werror LDFLAGS="-static" CFLAGS="-O2 -static"
        make -j$(nproc)

    - name: Verify binary
      run: |
        file gdb-14.1/gdb/gdbserver/gdbserver
        readelf -h gdb-14.1/gdb/gdbserver/gdbserver | grep -E "Machine|Data"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: gdbserver-mips64-be
        path: gdb-14.1/gdb/gdbserver/gdbserver
        retention-days: 30
